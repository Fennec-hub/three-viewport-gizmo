(function(m,a){typeof exports=="object"&&typeof module<"u"?a(exports,require("three")):typeof define=="function"&&define.amd?define(["exports","three"],a):(m=typeof globalThis<"u"?globalThis:m||self,a(m.ThreeViewportGizmo={},m.THREE))})(this,function(m,a){"use strict";var nt=Object.defineProperty;var at=(m,a,b)=>a in m?nt(m,a,{enumerable:!0,configurable:!0,writable:!0,value:b}):m[a]=b;var d=(m,a,b)=>(at(m,typeof a!="symbol"?a+"":a,b),b);const b=(t,e,i)=>{const n=document.createElement("div"),r=n.style,{top:o,left:s,right:c,bottom:h}=i;r.height=`${e}px`,r.width=`${e}px`,r.borderRadius="100%",r.position="absolute",r.background="#fff3",r.opacity="0",r.zIndex="10000";const[l,u]=t.split("-");return r.transform="",r.margin=`${o}px ${c}px ${h}px ${s}px`,r.left=u==="left"?"0":u==="center"?"50%":"",r.right=u==="right"?"0":"",r.transform+=u==="center"?"translateX(-50%)":"",r.top=l==="top"?"0":l==="bottom"?"":"50%",r.bottom=l==="bottom"?"0":"",r.transform+=l==="center"?"translateY(-50%)":"",n},L=["x","y","z","nx","ny","nz"],$={container:document.body,placement:"top-right",size:128,lineWidth:3,offset:{top:0,left:0,right:0,bottom:0},font:{family:"helvetica",weight:900},resolution:64,backgroundSphere:{enabled:!0,color:16777215,opacity:.2},x:{text:"X",colors:{main:"#ff3653"}},y:{text:"Y",colors:{main:"#8adb00"}},z:{text:"Z",colors:{main:"#2c8fff"}},nx:{drawLine:!1,colors:{main:"#ff3653"}},ny:{drawLine:!1,colors:{main:"#8adb00"}},nz:{drawLine:!1,colors:{main:"#2c8fff"}}},E=new a.Color,j=t=>{const e=[],i=[];L.forEach((r,o)=>{const s=t[r];if(s.drawLine===!1)return;const c=o<3?1:-1,h=o<3?.9:1.025;e.push(r.includes("x")?h*c:0,r.includes("y")?h*c:0,r.includes("z")?h*c:0,0,0,0);const l=s.colors.main,[u,p]=Array.isArray(l)?l:[l,l];i.push(...E.set(p).toArray(),...E.set(u).toArray())});const n=new a.BufferGeometry;return n.setAttribute("position",new a.BufferAttribute(new Float32Array(e),3)),n.setAttribute("color",new a.BufferAttribute(new Float32Array(i),3)),new a.LineSegments(n,new a.LineBasicMaterial({linewidth:t.lineWidth??3,vertexColors:!0}))},Q=t=>{const e=typeof t=="string"?document.querySelector(t):t;if(!e)throw Error("Invalid DOM element");return e};function G(t){const e=new a.SphereGeometry(1.6,64,64);return new a.Mesh(e,new a.MeshBasicMaterial({color:t,side:a.BackSide,transparent:!0,opacity:0,depthTest:!1}))}function X(t,e,i,n,r,o,s,c){const h=document.createElement("canvas");e=e??64;const l=.02;h.width=e*2+e*(l*4),h.height=e+e*(l*2);const u=e/2,p=e/2+e*l,P=p*3,f=h.getContext("2d");if(q(f,u,p,p,i,c),q(f,u,P,p,o||"#FFF",c),n!=null){const R=t.family||"sans-serif",w=t.weight||500,V=Y(f,n,R,w,e);f.textAlign="center",f.textBaseline="middle",f.fillStyle=r||"#000",f.fillText(n,p,p+V),f.fillStyle=s||r||"#000",f.fillText(n,P,p+V)}const S=new a.CanvasTexture(h);return S.colorSpace=a.SRGBColorSpace,S.wrapS=S.wrapT=a.RepeatWrapping,S.repeat.x=.5,new a.SpriteMaterial({map:S,toneMapped:!1,transparent:!0})}function q(t,e,i,n,r,o=!1){const s=n*.1;e=o?e-s:e,o&&(t.globalAlpha=.2),t.beginPath(),t.arc(i,n,e,0,2*Math.PI),t.closePath(),t.fillStyle=r,t.fill(),o&&(t.globalAlpha=1,t.strokeStyle=r,t.lineWidth=s,t.stroke())}function Y(t,e,i,n,r){const o=Math.sqrt(Math.pow(r*.7,2)/2);let s=o,c=0,h=0;do{t.font=`${n} ${s}px ${i}`;const p=t.measureText(e);c=p.width,h=p.fontBoundingBoxDescent,s--}while(c>o&&s>0);const l=Math.min(o/c,o/h),u=Math.floor(s*l);return t.font=`${n} ${u}px ${i}`,o/h}function H(t){const{font:e,resolution:i}=t;return L.map((n,r)=>{const{text:o,colors:s,border:c}=t[n],h=r<3,l=h?n:n[1],{text:u,main:p,hover:P,hoverText:f}=s,S=Array.isArray(p)?p[1]:p,R=c&&o,w=new a.Sprite(X(e,i,E.set(S).getStyle(),o,u&&E.set(u).getStyle()||null,P&&E.set(P).getStyle()||null,f&&E.set(f).getStyle()||null,c));return w.userData.type=n,w.userData.forceScale=R,w.scale.setScalar(R||h?.6:.4),w.position[l]=h?1.2:-1.2,w.renderOrder=1,w})}const v=new a.Object3D;function W(t,e,i){g.multiplyScalar(e.value).add(i),v.position.copy(i),v.lookAt(t.position),_.copy(v.quaternion),v.lookAt(g),C.copy(v.quaternion)}function A(t,e,i){e.value=t.position.distanceTo(i)}function Z(t,e,i,n){switch(i){case"x":g.set(1,0,0),y.setFromEuler(new a.Euler(0,Math.PI*.5,0));break;case"y":g.set(0,1,0),y.setFromEuler(new a.Euler(-Math.PI*.5,0,0));break;case"z":g.set(0,0,1),y.setFromEuler(new a.Euler);break;case"nx":g.set(-1,0,0),y.setFromEuler(new a.Euler(0,-Math.PI*.5,0));break;case"ny":g.set(0,-1,0),y.setFromEuler(new a.Euler(Math.PI*.5,0,0));break;case"nz":g.set(0,0,-1),y.setFromEuler(new a.Euler(0,Math.PI,0));break;default:console.error("ViewHelper: Invalid axis.")}A(t,n,e),W(t,n,e)}const x=new a.Vector3;function N(t,e){x.set(0,0,1),x.applyQuaternion(e.quaternion),x.x>=0?(t[0].material.opacity=1,t[3].material.opacity=.5):(t[0].material.opacity=.5,t[3].material.opacity=1),x.y>=0?(t[1].material.opacity=1,t[4].material.opacity=.5):(t[1].material.opacity=.5,t[4].material.opacity=1),x.z>=0?(t[2].material.opacity=1,t[5].material.opacity=.5):(t[2].material.opacity=.5,t[5].material.opacity=1)}function U(t,e,i=10){return Math.abs(t.clientX-e.x)<i&&Math.abs(t.clientY-e.y)<i}function O(t){let e=t.length;for(;e--;)t[e].scale.setScalar(e<3||t[e].userData.forceScale?.6:.4),t[e].material.map.offset.x=1}const k=new a.Vector2;function J(t,e,i){k.x=(t.clientX-e.left)/e.width*2-1,k.y=-((t.clientY-e.top)/e.height)*2+1,z.setFromCamera(k,i)}function B(t,e,i,n){J(t,e,i);const r=z.intersectObjects(n);return r.length?r[0].object:null}function K(t,e,i){return Math.min(Math.max(t,e),i)}const g=new a.Vector3,y=new a.Quaternion,_=new a.Quaternion,C=new a.Quaternion,z=new a.Raycaster,D=new a.Clock,tt=new a.Euler,et=2*Math.PI,T=new a.Vector2,I=new a.Vector2,M={value:0};let F=0;class it extends a.Object3D{constructor(i,n,r){var p;super();d(this,"_backgroundSphere");d(this,"_bgSphereOpacity",.2);d(this,"_spritePoints");d(this,"_container");d(this,"_domRect");d(this,"_viewport",new a.Vector4);d(this,"_renderer");d(this,"_orthoCamera",new a.OrthographicCamera(-1.8,1.8,1.8,-1.8,0,4));d(this,"_domElement");d(this,"_parentRect");d(this,"enabled",!0);d(this,"camera");d(this,"animated",!0);d(this,"animating",!1);d(this,"target",new a.Vector3);d(this,"dragging",!1);d(this,"size");d(this,"speed",1);this._renderer=n,this._container=n.domElement,this.camera=i,this._orthoCamera.position.set(0,0,2),r=Object.assign($,r||{});const{container:o,placement:s,size:c,offset:h,backgroundSphere:l}=r;this.size=c;const u=j(r);this._spritePoints=H(r),this.add(u,...this._spritePoints),l.enabled&&(this._backgroundSphere=G(l.color),this._bgSphereOpacity=l.opacity??.2,this.add(this._backgroundSphere)),this._domElement=b(s,c,h),Q(o).appendChild(this._domElement),this._domRect=this._domElement.getBoundingClientRect(),this._parentRect=(p=this._domElement.parentElement)==null?void 0:p.getBoundingClientRect(),this._startListening(),this.update()}render(){var o;this._domRect=this._domElement.getBoundingClientRect(),this._parentRect=(o=this._domElement.parentElement)==null?void 0:o.getBoundingClientRect(),this.animating&&this._animate();let i=this._domRect.left,n=F-this._domRect.bottom;this._parentRect&&(i-=this._parentRect.left,n+=this._parentRect.top);const r=this._renderer.autoClear;this._renderer.autoClear=!1,this._renderer.getViewport(this._viewport),this._renderer.setViewport(i,n,this.size,this.size),this._renderer.clear(!1,!0,!1),this._renderer.render(this,this._orthoCamera),this._renderer.setViewport(this._viewport),this._renderer.autoClear=r}update(){this._domRect=this._domElement.getBoundingClientRect(),F=this._container.offsetHeight,A(this.camera,M,this.target),this._renderer.getViewport(this._viewport),this._updateOrientation()}dispose(){this.children.forEach(i=>{var r,o,s,c;const n=i;(r=n.material)==null||r.dispose(),(s=(o=n.material)==null?void 0:o.map)==null||s.dispose(),(c=n.geometry)==null||c.dispose()}),this._domElement.remove()}_updateOrientation(i=!0){i&&(this.quaternion.copy(this.camera.quaternion).invert(),this.updateMatrixWorld()),N(this._spritePoints,this.camera)}_animate(){if(!this.animated){this.camera.quaternion.copy(y),this.animating=!1,this.dispatchEvent({type:"change"}),this.dispatchEvent({type:"end"});return}const n=D.getDelta()*et*this.speed;_.rotateTowards(C,n),this.camera.position.set(0,0,1).applyQuaternion(_).multiplyScalar(M.value).add(this.target),this.camera.quaternion.rotateTowards(y,n),this._updateOrientation(),requestAnimationFrame(()=>this.dispatchEvent({type:"change"})),_.angleTo(C)===0&&(this.animating=!1,this.dispatchEvent({type:"end"}))}_setOrientation(i){Z(this.camera,this.target,i,M),this.animating=!0,D.start(),this.dispatchEvent({type:"start"})}_startListening(){this._domElement.onpointerdown=i=>this._onPointerDown(i),this._domElement.onpointermove=i=>this._onPointerMove(i),this._domElement.onpointerleave=()=>this._onPointerLeave()}_onPointerDown(i){if(!this.enabled)return;const n=s=>{!this.dragging&&U(s,T)||(this.dragging||(O(this._spritePoints),this.dragging=!0),I.set(s.clientX,s.clientY).sub(T).multiplyScalar(1/this._domRect.width*Math.PI),this.rotation.x=K(o.x+I.y,Math.PI/-2+.001,Math.PI/2-.001),this.rotation.y=o.y+I.x,this.updateMatrixWorld(),_.copy(this.quaternion).invert(),this.camera.position.set(0,0,1).applyQuaternion(_).multiplyScalar(M.value).add(this.target),this.camera.rotation.setFromQuaternion(_),this._updateOrientation(!1),this.dispatchEvent({type:"change"}))},r=()=>{if(document.removeEventListener("pointermove",n,!1),document.removeEventListener("pointerup",r,!1),!this.dragging)return this._handleClick(i);this.dragging=!1,this.dispatchEvent({type:"end"})};if(this.animating===!0)return;i.preventDefault(),T.set(i.clientX,i.clientY);const o=tt.copy(this.rotation);A(this.camera,M,this.target),document.addEventListener("pointermove",n,!1),document.addEventListener("pointerup",r,!1),this.dispatchEvent({type:"start"})}_onPointerMove(i){!this.enabled||this.dragging||(this._backgroundSphere&&(this._backgroundSphere.material.opacity=this._bgSphereOpacity),this._handleHover(i))}_onPointerLeave(){!this.enabled||this.dragging||(this._backgroundSphere&&(this._backgroundSphere.material.opacity=0),O(this._spritePoints),this._domElement.style.cursor="")}_handleClick(i){const n=B(i,this._domRect,this._orthoCamera,this._spritePoints);n&&(this._setOrientation(n.userData.type),this.dispatchEvent({type:"change"}))}_handleHover(i){const n=B(i,this._domRect,this._orthoCamera,this._spritePoints);O(this._spritePoints),n?(n.material.map.offset.x=.5,n.scale.multiplyScalar(1.2),this._domElement.style.cursor="pointer"):this._domElement.style.cursor=""}}m.ViewportGizmo=it,m.q1=_,m.q2=C,m.raycaster=z,m.targetPosition=g,m.targetQuaternion=y,Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=three-viewport-gizmo.umd.cjs.map
